# > Установка инструментов
### Установка Lammps на Ubuntu
#### Через github:
>Перед установкой Lammps убедитесь что у вас установлены git и cmake.
>Если не установлены, то пропишите следующие команды:
```sudo apt-get install git``` и ```sudo apt-get cmake```

Создайте директорию в которой будут хранится исполняемые файлы и перейдите в неё. 
Пример:
```
mkdir lammps
cd lammps
```
Пропишите следующую команду, чтобы скачать необходимые файлы с git репозитория:
```
git clone -b stable https://github.com/lammps/lammps.git mylammps
cd mylammps/
```
В случае ошибки проверьте параметры установки и авторизации в git. Если же возникли проблемы непосредственно с репозиторием, проверьте его актуальность ( [официальный сайт lammps](https://guriang.unpad.ac.id/hpc/lammpsdoc/Install_git.html)  ).

> Проверьте наличие следующих пакетов и при их отсутствии установите их ( если вы работаете используя окружение conda, то вам прописывать эту команду не требуется ):
```
sudo apt install -y cmake build-essential ccache gfortran openmpi-bin libopenmpi-dev \
                    libfftw3-dev libjpeg-dev libpng-dev python3-dev python3-pip \
                    python3-virtualenv libblas-dev liblapack-dev libhdf5-serial-dev \
                    hdf5-tools
```

#### Процесс сборки:

Создаёте директорию для сборки:
```
mkdir build
cd build
```
>Если вы следовали чётко по данной инструкции то ваш путь должен представлять собой: ``` user-name:~/lammps/mylammps/build$ ```

Создайте Cmake:
```
cmake -C ../cmake/presets/basic.cmake -D PKG_MANYBODY=yes -D PKG_COLLOID=yes ../cmake
```
С помощью опции -D мы указываем дополнительные пакеты, которые будут включены в сборку.
Если во время работы с lammps возникает ошибка, что нет необходоимого пакета, то вернитесь к данному этапу. Скопируйте инструкцию выше и добавьте пакет для установки -D PKG_NAME=yes (NAME - имя пакета для установки)
```
cmake -C ../cmake/presets/basic.cmake -D PKG_MANYBODY=yes -D PKG_COLLOID=yes -D PKG_NAME=yes ../cmake
```
Список доступных пакетов содержится в документации: https://docs.lammps.org/Build_package.html

Чтобы запустить компиляцию программы, пропишите следующую команду:
```
make -j 4
```
Таким образом lammps был скомпилирован как библиотека. 
В директории build должен появиться исполняемый файл lmp. Данный файл можно копировать в директорию с расчетами или указывать путь до файла в директории build.

#### Запуск тестового расчёта:
В директории examples (lammps/mylammps/examples) содержатся примеры расчетов.
Находсь в данном каталоге перейдите в директорию colloid и скопируйте в него исполнемый файл lmp из build. 
Чтобы скопировать файл используют команду "cp PATH_FROM ." (точка обозначает текущую директорию)
```
cp ../../build/lmp .
```
Для запуска расчета выполните следующую команду:
```
cp lmp -in in.colloid
```
Пример вывода:

![image](https://github.com/IKCTO/mppi/assets/131967515/3387e379-9b42-4c5d-ab0c-e36edb2c0d64)

Чтобы прекратить работу нажмите Ctrl+c.

#### Дополнительные настройки
- Также находясь в lammps-install/bin пропишите команду ```pwd``` чтобы получить путь к файлу запуска ```lmp```. Скопируйте этот путь.
- Вернитесь в ```/home/user-name/``` ( достаточно прописать "cd" в командной строке ).
- Пропишите команду ```nano .bashrc```
- В конце отрытого файла пропишите: 
  ``` export PATH=$PATH:/home/user-name/lammps/lammps-install/bin```
  Нажмите ```Ctrl+x```, затем ```y``` и после ```Enter``` 

>Теперь при запуске новой сессии вы сможете запустить lammps командой ```lmp``` из любого каталога.

#### Установка LAMMPS совместимого с MLIP
Установите MLIP. Для этого выполните инструкции по данной ссылке: https://gitlab.com/ashapeev/mlip-2-tutorials/-/wikis/installation-tutorial
Чтобы установить lammps с mlip выполните инстуркции с 0-2: https://gitlab.com/ashapeev/interface-lammps-mlip-2/-/blob/master/README.md
Для выполнения третьего пункта скопируйте содержимое файла make_lammps.txt в конец файла preinstall.sh
Файл make_lammps.txt содержит все необходимые пакеты для работы с lammps. Запустите файл preinstall.sh
```
./preinstall.sh
```
В качестве четвертого пункта для компиляции выполните команду:
```
./install.sh ../mylammps mpi
```
---
### Установка VASP
> VASP 6.X.X on Ubuntu or Debian

#### Компилятор и библиотеки
Проверьте наличие компилятора и библиотек указанных  в таблице. Они необходимы для сборки VASP. 

| Compiler   | MPI           | FFT        | BLAS            | LAPACK | ScaLAPACK              | HDF5        | Known issues |
| ---------- | ------------- | ---------- | --------------- | ------ | ---------------------- | ----------- | ------------ |
| gcc-11.2.0 | openmpi-4.1.2 | fftw-3.3.8 | openblas-0.3.20 |        | netlib-scalapack-2.1.0 | hdf5-1.10.7 | -            |

Вы можете установить всё следующей командой:
```
sudo apt install rsync make build-essential g++ gfortran libopenblas-dev libopenmpi-dev libscalapack-openmpi-dev libfftw3-dev libhdf5-openmpi-dev
```
> **!** Если вы не можете пользоваться apt install по какой-либо причине ( например установка идёт на кластер ), то перейдите к установке через создание среды в conda.

#### Настройка среды в conda
> Подход установки через среду conda необходим для работы на кластере. Это позволяет каждому пользователю настроить среду работы под себя и не создаст конфликтов с установками другого пользователя. Однако это вызывает и отдельные сложности

# TO DO


#### Распаковка
Создайте директорию в которой планируете хранить файлы VASP. Перейдите в созданную директорию и распакуйте исходники кода. Далее перейдите в распакованную директорию, в ней вы должны обнаружить папку `arch`. В этой папке подготовлены примеры makefile для различных систем. В случае Ubuntu или Debian вам стоит выбрать `makefile.include.gnu_omp`. Переходить в директорию arch не надо. Вам достаточно прописать следующую команду, скопировав необходимый makefile: `cp arch/makefile.include.gnu_omp makefile.include`
На этом шаге ваша директория должна содержать следующие элементы:
![[Pasted image 20240427004500.png]]

#### Настройка makefile
Откройте makefile ( например с помощью `nano makefile.include` ). Далее начиная со строки в которой указано `## Customize as of this point!` внесите следующие изменения:
>Закомментируйте `OPENBLAS_ROOT` и измените параметр `BLASPACK`:
```
# BLAS and LAPACK (mandatory)
#OPENBLAS_ROOT ?= /path/to/your/openblas/installation
BLASPACK    = -lopenblas
```
>Закомментируйте `SCALAPACK_ROOT` и измените параметр `SCALAPACK`:
```
# scaLAPACK (mandatory)
#SCALAPACK_ROOT ?= /path/to/your/scalapack/installation
SCALAPACK   = -lscalapack-openmpi
```
>Закомментируйте `FFTW_ROOT`. Измените параметры `LLIBS` и `INCS`:
```
# FFTW (mandatory)
#FFTW_ROOT  ?= /path/to/your/fftw/installation
LLIBS      += -lfftw3 -lfftw3_omp
INCS       += -I/usr/include
```
>Включите поддержку HDF5 добавив `-DVASP_HDF5` в переменную `CPP_OPTIONS`. Закомментируйте `HDF5_ROOT`. измените параметры `LLIBS` и `INCS`:
```
# HDF5-support (optional but strongly recommended)
CPP_OPTIONS+= -DVASP_HDF5
#HDF5_ROOT  ?= /path/to/your/hdf5/installation
LLIBS      += -L/usr/lib/x86_64-linux-gnu/hdf5/openmpi/ -lhdf5_fortran
INCS       += -I/usr/include/hdf5/openmpi/
```
> **Save your `makefile.include` and compile VASP:**
```
make DEPS=1 -j
```
>После завершения процесса сборки двоичные файлы будут размещены во вложенной папке VASP bin. Они были скомпилированы с поддержкой OpenMP-threading. Перед запуском VASP, пожалуйста, всегда проверяйте, установлена ли переменная среды OMP_NUM_THREADS в соответствии с вашими потребностями. Например, если вам требуется только чистое распараллеливание MPI без многопоточности OpenMP, добавьте в `~/.bashrc`
```
export OMP_NUM_THREADS=1
```

# > Базовые функции инструментов

## VASP
#### Где искать информацию:
- Мануал по VASP (нужен vpn) - https://www.vasp.at/wiki/index.php/The_VASP_Manual
- Видео с основами DFT и VASP - https://www.youtube.com/watch?v=SXvhDLCycxc&list=PLOySabnxhDbWNhbi4k-iDto9XA5Kj7E_T&t=1203s&ab_channel=VirtualSimulationLab
### Основные входные файлы:
#### 1) POTCAR – файл с псевдопотенциалом
> Что важно: 
- Существуют различные псевдопотенциалы с разными типами обменно-корреляционных функционалов GGA – для электронных, оптических свойств, PBE – для механических свойств
- В файле POTCAR нужно найти параметр ENMAX, он нужен для задания ENCUT в INCAR файле (ENCUT = 1.5 ENMAX)
#### 2) POSCAR – файл с начальной конфигурацией атомов
>Что важно: 
- Указывать типы атомов стоит в порядке, в котором они идут в периодической системе элементов
- Можно задавать как прямые (Direct), так и декартовы координаты атомов (Cartesian)
- В файле можно занулить проекции сил, действующие на атомы (“заморозить” атомы), T – силы действуют вдоль оси, F – силы не действуют вдоль оси, задав F F F для атома, он становится полностью неподвижным.
- Для создания начальных конфигураций систем атомов стоит использовать Python библиотеку ase
- Для CVD есть скрипт для создания начальной конфигурации меди, он хранится в папке jupyter_notebook
#### 3) INCAR – файл со скриптом исполняемой программы
> Что важно: 
- Все команды и переменные можно посмотреть по ссылке к мануалу по VASP.
- Основные параметры
  PREC = Accurate (точность вычислений, по умолчанию, medium)
  ENCUT = 600 – энергия отсечки, ограничивает диапазон волновых чисел для базиса волновых функций (ENCUT = 1.5 ENMAX) 
  ISYM   = 0 – использование симметрии плотности заряда (0 – симметрия не используется)
  IVDW = 2 – включение Ван-дер-Ваальсова взаимодействия (описание смотреть в мануале)
  IBRION = 0 - параметр задает перемещение ионов (“-1” – ионы неподвижны, нужно для одиночного DFT расчета, “0” – молекулярная динамика, остальное смотреть в мануале)
  **Параметры для молекулярной динамики** NSW    = 1000 – число шагов молекулярной динамики
  POTIM  = 2.0 – шаг молекулярной динамики в фс
  MDALGO = 0        ! Microcanonical (NVE) – задают тип ансамбля атомов или термостата
  SMASS  = -3       ! Nosé mass – задают тип ансамбля атомов или термостата
  TEBEG  = 1000     !  начальная температура системы
  ISIF   = 2       ! 
  
  LREAL = .FALSE. 
  LWAVE = .FALSE. – запись волновых функций в WAVECAR файл
  LCHARG = .FALSE. – запись плотностей зарядов в файлы CHGCAR и CHGG
  NCORE = 2 
#### 4) KPOINTS
>Что важно: 
- Можно запускать расчеты без этого файла, если в файле INCAR указан параметр KSPACING.
- KSPACING обычно лежит в диапазоне 0.15-0.25, 0.15 - для металлов, 0.25 - для неметаллов.
- Лучше запускать расчеты с использованием файла KPOINTS, для этого стоит запустить расчет без файла KPOINTS, а параметры k-сетки можно посмотреть в файле OUTCAR после начала расчета, а расчет остановить. После создаем с этими параметрами файл KPOINTS и снова запускаем расчет.
  **Основные выходные файлы:**
  - OUTCAR – файл, с основными выходными параметрами (энергиями, силами на атом, напряжениями и тд.). Именно этот файл используется для дальнейшего обучения потенциала в MLIP
  - CONTCAR – файл с конфигурацией атомов на последнем исполняемом шаге по времени (с данного шага можно продолжить молекулярную динамику)
  - XDATCAR – файл с полной траекторией атомов
#### Как запускать: ввести команду в терминале
```
mpirun – np 4 –x OMP_NUM_THREADS=2 vasp_std
```
